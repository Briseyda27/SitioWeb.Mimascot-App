<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro / Ingreso</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #ffe5ec, #fff5e4);
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      border-radius: 1rem;
      background-color: #fffdfb;
      border: none;
    }
    .btn-success {
      background-color: #fbb1bd;
      border: none;
    }
    .btn-success:hover {
      background-color: #f89cab;
    }
    .btn-primary {
      background-color: #fcd5ce;
      border: none;
      color: #6c4c4c;
    }
    .btn-primary:hover {
      background-color: #f8b4a0;
      color: #fff;
    }
    h2 {
      color: #6c4c4c;
    }
  </style>
</head>
<body>

<div class="container py-5">
  <h2 class="text-center mb-4">Crea tu cuenta o inicia sesión</h2>
  <div class="card p-4 shadow-sm mx-auto" style="max-width: 400px;">
    <div class="mb-3">
      <label class="form-label">Correo electrónico</label>
      <input type="email" id="email" class="form-control" placeholder="tucorreo@ejemplo.com">
    </div>
    <div class="mb-3">
      <label class="form-label">Contraseña</label>
      <input type="password" id="password" class="form-control" placeholder="Mínimo 6 caracteres">
    </div>
    <div class="d-flex gap-2">
      <button id="btn-signup" class="btn btn-success w-50">Crear cuenta</button>
      <button id="btn-login" class="btn btn-primary w-50">Ingresar</button>
    </div>
    <div id="auth-error" class="text-danger small mt-2"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc, 
    serverTimestamp, 
    Timestamp 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDeF0B1wEupn4icVvAbdkhxl8pji53gfuY",
    authDomain: "premium-34ee0.firebaseapp.com",
    projectId: "premium-34ee0",
    storageBucket: "premium-34ee0.firebasestorage.app",
    messagingSenderId: "707778949824",
    appId: "1:707778949824:web:7af4e01cba5d5021647325"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function addDaysAsTimestamp(date, days) {
    const d = new Date(date);
    d.setDate(d.getDate() + days);
    return Timestamp.fromDate(d);
  }

  document.getElementById('btn-signup').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    const err = document.getElementById('auth-error');
    err.textContent = '';
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await setDoc(doc(db, "users", cred.user.uid), {
        email,
        createdAt: serverTimestamp(),
        trialEnd: addDaysAsTimestamp(new Date(), 7),
        subscription: { active: false }
      });
    } catch (e) {
      err.textContent = e.message;
    }
  });

  document.getElementById('btn-login').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value.trim();
    const err = document.getElementById('auth-error');
    err.textContent = '';
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      err.textContent = e.message;
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const now = new Date();
        const trialEnd = data.trialEnd.toDate();
        if (data.subscription?.active) {
          window.location.href = "index.html";
        } else if (now < trialEnd) {
          window.location.href = "index.html";
        } else {
          window.location.href = "pago.html";
        }
      }
    }
  });
</script>
</body>
</html>
